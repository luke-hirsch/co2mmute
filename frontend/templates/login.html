{% extends "base.html" %}
{% load static %}
{% block title %}Anmelden oder Registrieren - MobilityGame{% endblock %}
{% block content %}
<section class="flex min-h-[80vh] items-center justify-center bg-brand-50 px-4">
  <div class="mx-auto w-full max-w-md">
    <div class="rounded-3xl border border-slate-200 bg-white p-8 shadow-sm">
      <div class="mb-8 text-center">
        <div class="mb-4 flex justify-center">
          <div
            class="flex h-12 w-12 items-center justify-center rounded-2xl bg-brand-500"
          >
            <svg
              viewBox="0 0 48 48"
              xmlns="http://www.w3.org/2000/svg"
              class="h-7 w-7 text-brand-50"
            >
              <path
                d="M24 36 V18 M24 18 L14 12 M24 18 L34 12"
                stroke="currentColor"
                stroke-width="3"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <circle cx="13" cy="11" r="2" fill="currentColor"></circle>
              <circle cx="35" cy="11" r="2" fill="currentColor"></circle>
              <circle cx="24" cy="38" r="2" fill="currentColor"></circle>
            </svg>
          </div>
        </div>
        <h1 id="auth-heading" class="text-2xl font-bold text-slate-900">
          {% if mode == "signup" %}Registrierung{% else %}Anmeldung{% endif %}
        </h1>
        <p id="auth-description" class="mt-2 text-sm text-slate-600">
          {% if mode == "signup" %}
          Erstellen Sie ein neues Konto und starten Sie anschließend eine
          Spielsitzung.
          {% else %}
          Melden Sie sich an, um eine neue Spielsitzung zu starten.
          {% endif %}
        </p>
      </div>

      {% if mode == "signup" and signup_form.non_field_errors %}
      <div
        class="mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
      >
        {% for error in signup_form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% elif login_form.non_field_errors %}
      <div
        class="mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"
      >
        {% for error in login_form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
      </div>
      {% endif %}

      <div class="mb-6 flex justify-center gap-2">
        <button
          type="button"
          class="rounded-full px-4 py-2 text-sm font-semibold transition"
          data-auth-toggle="login"
        >
          Anmelden
        </button>
        <button
          type="button"
          class="rounded-full px-4 py-2 text-sm font-semibold transition"
          data-auth-toggle="signup"
        >
          Registrieren
        </button>
      </div>

      <form method="post" id="auth-form" class="space-y-6" novalidate>
        {% csrf_token %}
        <input type="hidden" name="mode" id="auth-mode" value="{{ mode }}" />
        {% if next %}
        <input type="hidden" name="next" value="{{ next }}" />
        {% endif %}

        <div
          data-auth-section="login"
          class="space-y-6 {% if mode != 'login' %}hidden{% endif %}"
          {% if mode != "login" %}aria-hidden="true"{% endif %}
        >
          <div>
            <label
              for="login-username"
              class="mb-2 block text-sm font-medium text-slate-700"
            >
              Benutzername oder E-Mail
            </label>
            <input
              type="text"
              name="username"
              id="login-username"
              value="{{ login_form.username.value|default_if_none:'' }}"
              autocomplete="username"
              placeholder="z. B. gruppe-7a oder lehrkraft@example.de"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="login"
              data-required="true"
              {% if mode != "login" %}disabled{% else %}required{% endif %}
            />
            {% for error in login_form.username.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>

          <div>
            <div class="mb-2 flex items-center justify-between">
              <label
                for="login-password"
                class="block text-sm font-medium text-slate-700"
              >
                Passwort
              </label>
              <button
                type="button"
                id="password-toggle"
                class="text-xs font-medium text-slate-500 hover:text-slate-700"
              >
                Anzeigen
              </button>
            </div>
            <input
              type="password"
              name="password"
              id="login-password"
              value=""
              autocomplete="current-password"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="login"
              data-required="true"
              {% if mode != "login" %}disabled{% else %}required{% endif %}
            />
            {% for error in login_form.password.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>
        </div>

        <div
          data-auth-section="signup"
          class="space-y-4 {% if mode != 'signup' %}hidden{% endif %}"
          {% if mode != "signup" %}aria-hidden="true"{% endif %}
        >
          <div>
            <label
              for="signup-username"
              class="mb-2 block text-sm font-medium text-slate-700"
            >
              Benutzername
            </label>
            <input
              type="text"
              name="username"
              id="signup-username"
              value="{{ signup_form.username.value|default_if_none:'' }}"
              autocomplete="username"
              placeholder="z. B. gruppe-7a"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="signup"
              data-required="true"
              {% if mode != "signup" %}disabled{% else %}required{% endif %}
            />
            {% for error in signup_form.username.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>

          <div>
            <label
              for="signup-email"
              class="mb-2 block text-sm font-medium text-slate-700"
            >
              E-Mail-Adresse
            </label>
            <input
              type="email"
              name="email"
              id="signup-email"
              value="{{ signup_form.email.value|default_if_none:'' }}"
              autocomplete="email"
              placeholder="lehrkraft@example.de"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="signup"
              data-required="true"
              {% if mode != "signup" %}disabled{% else %}required{% endif %}
            />
            {% for error in signup_form.email.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>

          <div>
            <label
              for="signup-password1"
              class="mb-2 block text-sm font-medium text-slate-700"
            >
              Passwort
            </label>
            <input
              type="password"
              name="password1"
              id="signup-password1"
              autocomplete="new-password"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="signup"
              data-required="true"
              {% if mode != "signup" %}disabled{% else %}required{% endif %}
            />
            {% for error in signup_form.password1.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>

          <div>
            <label
              for="signup-password2"
              class="mb-2 block text-sm font-medium text-slate-700"
            >
              Passwort (Wiederholung)
            </label>
            <input
              type="password"
              name="password2"
              id="signup-password2"
              autocomplete="new-password"
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-slate-900 placeholder-slate-400 focus:border-brand-500 focus:ring-2 focus:ring-brand-100"
              data-mode-field="signup"
              data-required="true"
              {% if mode != "signup" %}disabled{% else %}required{% endif %}
            />
            {% for error in signup_form.password2.errors %}
            <p class="mt-1 text-xs text-red-600">{{ error }}</p>
            {% endfor %}
          </div>

          {% if password_help_text %}
          <div class="text-xs text-slate-500">
            {{ password_help_text|safe }}
          </div>
          {% endif %}
        </div>

        <button
          type="submit"
          id="auth-submit"
          class="w-full rounded-full bg-brand-500 px-6 py-2.5 text-sm font-semibold text-white hover:bg-brand-600 focus:outline-none focus:ring-2 focus:ring-brand-300 focus:ring-offset-2"
        >
          {% if mode == "signup" %}Registrieren{% else %}Anmelden{% endif %}
        </button>
      </form>

      <div class="mt-6 text-center text-xs text-slate-500">
        {% if mode == "signup" %}
        Bereits registriert? Wechseln Sie oben zur Anmeldung.
        {% else %}
        Noch kein Konto? Wechseln Sie oben zur Registrierung.
        {% endif %}
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modeInput = document.getElementById("auth-mode");
    const sections = document.querySelectorAll("[data-auth-section]");
    const toggleButtons = document.querySelectorAll("[data-auth-toggle]");
    const fields = document.querySelectorAll("[data-mode-field]");
    const heading = document.getElementById("auth-heading");
    const description = document.getElementById("auth-description");
    const submitButton = document.getElementById("auth-submit");
    const passwordInput = document.getElementById("login-password");
    const togglePasswordButton = document.getElementById("password-toggle");

    const copy = {
      login: {
        heading: "Anmeldung",
        description:
          "Melden Sie sich an, um eine neue Spielsitzung zu starten.",
        submit: "Anmelden",
      },
      signup: {
        heading: "Registrierung",
        description:
          "Erstellen Sie ein neues Konto und starten Sie anschließend eine Spielsitzung.",
        submit: "Registrieren",
      },
    };

    const applyMode = (mode) => {
      const normalizedMode = mode === "signup" ? "signup" : "login";
      modeInput.value = normalizedMode;

      sections.forEach((section) => {
        const active = section.dataset.authSection === normalizedMode;
        section.classList.toggle("hidden", !active);
        section.setAttribute("aria-hidden", (!active).toString());
      });

      fields.forEach((field) => {
        const active = field.dataset.modeField === normalizedMode;
        field.disabled = !active;
        const shouldRequire = field.dataset.required === "true";
        field.required = active && shouldRequire;
      });

      toggleButtons.forEach((button) => {
        const active = button.dataset.authToggle === normalizedMode;
        button.classList.toggle("bg-brand-500", active);
        button.classList.toggle("text-white", active);
        button.classList.toggle("border", !active);
        button.classList.toggle("border-slate-200", !active);
        button.classList.toggle("text-slate-600", !active);
      });

      const texts = copy[normalizedMode];
      if (heading) {
        heading.textContent = texts.heading;
      }
      if (description) {
        description.textContent = texts.description;
      }
      if (submitButton) {
        submitButton.textContent = texts.submit;
      }
    };

    toggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        applyMode(button.dataset.authToggle);
      });
    });

    if (togglePasswordButton && passwordInput) {
      togglePasswordButton.addEventListener("click", () => {
        const isPassword = passwordInput.type === "password";
        passwordInput.type = isPassword ? "text" : "password";
        togglePasswordButton.textContent = isPassword
          ? "Verbergen"
          : "Anzeigen";
      });
    }

    applyMode(modeInput.value);
  });
</script>
{% endblock %}
